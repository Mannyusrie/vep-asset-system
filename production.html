<!DOCTYPE html>
<html>
<head>
    <title>Production Dashboard | V.E.P</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        h2 { border-bottom: 1px solid rgba(0, 210, 255, 0.2); padding-bottom: 15px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #photoPreview { 
            width: 100%; height: 100px; border: 1px dashed rgba(0, 210, 255, 0.3); 
            border-radius: 12px; margin-top: 10px; display: none; object-fit: contain; 
            background: #050505; 
        }
        .item-img { 
            width: 50px; height: 50px; object-fit: cover; border-radius: 8px; 
            border: 1px solid #222; cursor: pointer; transition: 0.3s;
        }
        .item-img:hover { border-color: var(--saber-blue); box-shadow: var(--saber-glow); }
        .btn-qr { 
            background: transparent; color: var(--saber-blue); border: 1px solid var(--saber-blue);
            padding: 5px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px;
        }
        .btn-qr:hover { background: var(--saber-blue); color: #000; box-shadow: var(--saber-glow); }
        .btn-delete { 
            color: #ff4444; background: transparent; border: 1px solid #ff4444; 
            padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 10px; 
        }
        .btn-delete:hover { background: #ff4444; color: #fff; box-shadow: 0 0 10px #ff4444; }
        
        .filter-bar {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid #222;
        }
        .filter-input {
            background: #111; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; flex: 1; min-width: 150px;
        }
        
        #requestSection, #damageSection { margin-bottom: 25px; border-radius: 15px; overflow: hidden; }
        #requestSection { border: 2px solid #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.1); }
        #damageSection { border: 2px solid #ff4444; box-shadow: 0 0 15px rgba(255, 68, 68, 0.1); }
        
        .btn-approve { background: #facc15; color: #000; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-fixed { background: #4ade80; color: #000; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        #qrModal canvas { background: #fff; padding: 10px; border-radius: 10px; box-shadow: var(--saber-intense); }
        .status-available { color: #4ade80; font-weight: bold; }
        .status-inuse { color: var(--saber-blue); font-weight: bold; }
        .status-damaged { color: #ff4444; font-weight: bold; animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        .event-tag { color: #facc15; font-size: 11px; font-weight: bold; display: block; margin-top: 4px; }
        .damage-note { color: #ffaaaa; font-size: 10px; font-style: italic; display: block; margin-top: 4px; }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <img src="logo.png" style="height: 40px;">
        <h1>V.E.P | <span style="color: var(--saber-blue); text-shadow: var(--saber-glow);">PRODUCTION</span></h1>
    </div>
    <button onclick="location.reload()" class="btn-logout" style="background: transparent !important; color: var(--saber-blue) !important; border: 1px solid var(--saber-blue) !important;">REFRESH</button>
</header>

<div class="container">
    <div id="damageSection" class="card" style="display:none;">
        <h2 style="color: #ff4444; border-bottom-color: #ff4444;">⚠️ MAINTENANCE & DAMAGE REPORTS</h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%;">
                <tbody id="damageTable"></tbody>
            </table>
        </div>
    </div>

    <div id="requestSection" class="card" style="display:none;">
        <h2 style="color: #facc15; border-bottom-color: #facc15;">⚠️ INCOMING REQUESTS</h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%;">
                <tbody id="requestTable"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ADD NEW ITEM</h2>
        <div class="form-grid">
            <div>
                <label>ITEM NAME</label>
                <input id="invName" placeholder="e.g. LED P2.5">
            </div>
            <div>
                <label>CATEGORY</label>
                <input id="invCat" placeholder="e.g. Visual">
            </div>
            <div>
                <label>INITIAL LOCATION</label>
                <select id="invLoc">
                    <option value="OFFICE">OFFICE</option>
                    <option value="MAIN STORE">MAIN STORE</option>
                </select>
            </div>
            <div>
                <label>IMAGE PROOF</label>
                <input type="file" id="invImg" accept="image/*" onchange="previewImage(this)">
                <img id="photoPreview">
            </div>
        </div>
        <button id="btnAdd" onclick="addItem()" style="margin-top: 25px;">+ ADD TO INVENTORY</button>
    </div>

    <div class="card">
        <h2>CLOUD INVENTORY</h2>
        
        <div class="filter-bar">
            <input type="text" id="searchBox" class="filter-input" placeholder="Search name or category..." onkeyup="runFilters()">
            
            <select id="filterLoc" class="filter-input" onchange="runFilters()">
                <option value="ALL">ALL LOCATIONS</option>
                <option value="OFFICE">OFFICE</option>
                <option value="MAIN STORE">MAIN STORE</option>
                <option value="ON VENUE / OTHERS">ON VENUE / OTHERS</option>
            </select>

            <select id="filterCat" class="filter-input" onchange="runFilters()">
                <option value="ALL">ALL CATEGORIES</option>
            </select>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>IMAGE</th>
                        <th>ITEM NAME</th>
                        <th>CATEGORY</th>
                        <th>LOCATION</th>
                        <th>STATUS</th>
                        <th>ACTION</th>
                        <th>QR</th>
                    </tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:#000; padding:40px; border: 2px solid var(--saber-blue); border-radius:20px; text-align:center;">
        <canvas id="qrCanvas"></canvas>
        <h2 id="qrLabel" style="color:var(--saber-blue); margin-top:20px; border:none;"></h2>
    </div>
    <button onclick="document.getElementById('qrModal').style.display='none'" style="margin-top:20px; width: auto; padding: 10px 40px;">CLOSE</button>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBf_L5FuHaaERVG4N2qMl_4HIk-3-nw9Mk",
    authDomain: "vep-inventory.firebaseapp.com",
    databaseURL: "https://vep-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vep-inventory",
    storageBucket: "vep-inventory.firebasestorage.app",
    messagingSenderId: "858682132166",
    appId: "1:858682132166:web:fa05f064398fe418afb9c7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- SEARCH & FILTER ---
function runFilters() {
    const search = document.getElementById('searchBox').value.toUpperCase();
    const loc = document.getElementById('filterLoc').value;
    const cat = document.getElementById('filterCat').value;
    const rows = document.querySelectorAll("#inventoryTable tr");

    rows.forEach(row => {
        const name = row.cells[1].innerText.toUpperCase();
        const category = row.cells[2].innerText.toUpperCase();
        const location = row.cells[3].innerText.toUpperCase();

        const matchSearch = name.includes(search) || category.includes(search);
        const matchLoc = (loc === "ALL") || location.includes(loc);
        const matchCat = (cat === "ALL") || category === cat;

        row.style.display = (matchSearch && matchLoc && matchCat) ? "" : "none";
    });
}

function updateCategoryDropdown(items) {
    const dropdown = document.getElementById('filterCat');
    const categories = new Set();
    Object.values(items).forEach(item => { if(item.category) categories.add(item.category.toUpperCase()); });
    const currentSelection = dropdown.value;
    dropdown.innerHTML = '<option value="ALL">ALL CATEGORIES</option>';
    Array.from(categories).sort().forEach(c => { dropdown.innerHTML += `<option value="${c}">${c}</option>`; });
    dropdown.value = currentSelection;
}

// --- CORE REAL-TIME ---
db.ref("items").on("value", (snap) => {
    const table = document.getElementById("inventoryTable");
    const damageTable = document.getElementById("damageTable");
    const damageSection = document.getElementById("damageSection");
    table.innerHTML = ""; damageTable.innerHTML = "";
    let damageCount = 0;
    const allData = snap.val() || {};
    updateCategoryDropdown(allData);

    snap.forEach((child) => {
        const item = child.val();
        // Lokasi "Available" ialah OFFICE atau MAIN STORE
        const isInStore = ["OFFICE", "MAIN STORE"].includes(item.location);
        const imgTag = item.image ? `<img src="${item.image}" class="item-img" onclick="window.open(this.src)">` : `<small style="color:#333;">NO IMAGE</small>`;
        
        if(item.status === "DAMAGED") {
            damageCount++;
            damageTable.innerHTML += `
                <tr style="border-bottom: 1px solid rgba(255,68,68,0.1);">
                    <td style="padding:15px; color:#fff;">${imgTag} <b style="color:#ff4444;">${item.name}</b> <span class="damage-note">Issue: ${item.lastReport || "No details"}</span></td>
                    <td style="text-align:right; padding-right:15px;"><button class="btn-fixed" onclick="markAsFixed('${item.id}')">FIXED</button></td>
                </tr>`;
        }

        let statusClass = isInStore ? 'status-available' : 'status-inuse';
        let statusText = isInStore ? 'AVAILABLE' : 'IN USE';
        if(item.status === "DAMAGED") { statusClass = 'status-damaged'; statusText = 'DAMAGED'; }

        table.innerHTML += `
            <tr>
                <td>${imgTag}</td>
                <td><b style="color:#fff">${item.name}</b></td>
                <td><small style="color:#888">${item.category}</small></td>
                <td><span class="location-tag" style="background:rgba(0,210,255,0.1); color:#00d2ff; padding:2px 6px; border-radius:4px;">${item.location}</span></td>
                <td><span class="${statusClass}">● ${statusText}</span><small style="color:#555; display:block;">${item.job || ""}</small></td>
                <td><button onclick="if(confirm('Delete?')) db.ref('items/${child.key}').remove()" class="btn-delete">DEL</button></td>
                <td><button class="btn-qr" onclick="showQR('${child.key}', '${item.name}')">QR</button></td>
            </tr>`;
    });
    damageSection.style.display = damageCount > 0 ? "block" : "none";
    runFilters();
});

// --- CORE HELPERS ---
function previewImage(input) {
    const preview = document.getElementById('photoPreview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
        reader.readAsDataURL(input.files[0]);
    }
}

function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                let width = img.width; let height = img.height;
                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL("image/jpeg", 0.7));
            };
        };
    });
}

async function addItem() {
    const name = document.getElementById('invName').value.trim();
    const cat = document.getElementById('invCat').value.trim();
    const loc = document.getElementById('invLoc').value;
    const imgFile = document.getElementById('invImg').files[0];
    const btn = document.getElementById('btnAdd');
    if(!name) return alert("Item Name is required!");
    btn.disabled = true; btn.innerText = "PROCESSING...";
    let imgBase64 = imgFile ? await compressImage(imgFile) : "";
    const newRef = db.ref("items").push();
    await newRef.set({ id: newRef.key, name, category: cat || "General", location: loc, image: imgBase64, status: "Available", lastUpdate: Date.now(), pm: "-", job: "" });
    alert("Item added!"); location.reload();
}

function showQR(id, name) {
    const modal = document.getElementById('qrModal');
    const canvas = document.getElementById('qrCanvas');
    document.getElementById('qrLabel').innerText = name;
    QRCode.toCanvas(canvas, id, { width: 280, margin: 2 }, (err) => { if(!err) modal.style.display='flex'; });
}

async function markAsFixed(itemId) {
    if(!confirm("Is this item fixed?")) return;
    await db.ref("items/" + itemId).update({ status: "Available", location: "MAIN STORE", lastReport: null, pm: "Production (Fixed)" });
}

// Request Sync
db.ref("requests").on("value", (snap) => {
    const table = document.getElementById("requestTable");
    const section = document.getElementById("requestSection");
    table.innerHTML = ""; let count = 0;
    snap.forEach((child) => {
        const req = child.val(); count++;
        table.innerHTML += `
            <tr style="border-bottom: 1px solid rgba(250,204,21,0.1);">
                <td style="padding:15px; color:#fff;"><b>${req.name}</b> by ${req.requestedBy}</td>
                <td style="text-align:right; padding-right:15px;"><button class="btn-approve" onclick="approveRequest('${child.key}')">APPROVE</button></td>
            </tr>`;
    });
    section.style.display = count > 0 ? "block" : "none";
});

async function approveRequest(reqId) {
    db.ref("requests/" + reqId).once("value", async (snap) => {
        const d = snap.val();
        const newRef = db.ref("items").push();
        await newRef.set({ id: newRef.key, name: d.name, category: "General", location: "MAIN STORE", image: d.itemImage || "", status: "Available", lastUpdate: Date.now(), pm: "-", job: "" });
        db.ref("requests/" + reqId).remove();
        alert("Approved!");
    });
}
</script>
</body>
</html>