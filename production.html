<!DOCTYPE html>
<html>
<head>
    <title>Production Dashboard | V.E.P</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <style>
        h2 { border-bottom: 1px solid rgba(0, 210, 255, 0.2); padding-bottom: 15px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* FIX BERTINDIH: Sangkar Gambar */
        .img-box {
            width: 60px; height: 60px; 
            min-width: 60px; border-radius: 8px;
            overflow: hidden; border: 1px solid #333;
            background: #000; display: flex; align-items: center; justify-content: center;
            cursor: zoom-in;
        }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }

        #photoPreview { 
            width: 100%; height: 100px; border: 1px dashed rgba(0, 210, 255, 0.3); 
            border-radius: 12px; margin-top: 10px; display: none; object-fit: contain; 
            background: #050505; 
        }

        /* Table Spacing */
        table { border-collapse: separate; border-spacing: 0 12px; width: 100%; }
        td { padding: 12px 15px; background: rgba(255,255,255,0.02); vertical-align: middle; }
        
        /* DESIGN BUTANG STACKED (ATAS BAWAH) */
        .action-cell {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100px; /* Lebar tetap supaya kemas */
        }

        .btn-action { 
            background: transparent;
            padding: 8px 0; /* Guna padding atas bawah je */
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 11px;
            transition: 0.3s; 
            text-transform: uppercase;
            text-align: center;
            width: 100%; /* Penuhkan sangkar action-cell */
            display: block;
        }

        /* Style Butang QR */
        .btn-qr-new { color: var(--saber-blue); border: 1px solid var(--saber-blue); }
        .btn-qr-new:hover { background: var(--saber-blue); color: #000; box-shadow: var(--saber-glow); }

        /* Style Butang DELETE */
        .btn-delete-new { color: #ff4444; border: 1px solid #ff4444; }
        .btn-delete-new:hover { 
            background: #ff4444; color: #fff; 
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4); 
        }

        #requestSection, #damageSection { margin-bottom: 25px; border-radius: 15px; overflow: hidden; }
        #requestSection { border: 2px solid #facc15; }
        #damageSection { border: 2px solid #ff4444; }

        /* IMAGE LIGHTBOX */
        #imageModal {
            display: none; position: fixed; z-index: 10000; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            justify-content: center; align-items: center; cursor: zoom-out;
        }
        #imageModal img { 
            max-width: 90%; max-height: 90%; border: 2px solid var(--saber-blue); 
            border-radius: 10px; box-shadow: 0 0 30px rgba(0,210,255,0.5); 
        }

        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; text-align: center; }
        }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <img src="logo.png" style="height: 40px;">
        <h1>V.E.P | <span style="color: var(--saber-blue); text-shadow: var(--saber-glow);">PRODUCTION</span></h1>
    </div>
    <button onclick="location.reload()" class="btn-logout">REFRESH</button>
</header>

<div class="container">
    <div id="damageSection" class="card" style="display:none;">
        <h2 style="color: #ff4444; border-bottom-color: #ff4444;">⚠️ DAMAGE REPORTS</h2>
        <table style="width: 100%;">
            <tbody id="damageTable"></tbody>
        </table>
    </div>

    <div id="requestSection" class="card" style="display:none;">
        <h2 style="color: #facc15; border-bottom-color: #facc15;">⚠️ INCOMING REQUESTS</h2>
        <table style="width: 100%;">
            <tbody id="requestTable"></tbody>
        </table>
    </div>

    <div class="card">
        <h2>ADD NEW ITEM</h2>
        <div class="form-grid">
            <div><label>ITEM NAME</label><input id="invName" placeholder="e.g. LED P2.5"></div>
            <div><label>CATEGORY</label><input id="invCat" placeholder="e.g. Visual"></div>
            <div>
                <label>INITIAL LOCATION</label>
                <select id="invLoc">
                    <option value="OFFICE">OFFICE</option>
                    <option value="MAIN STORE">MAIN STORE</option>
                </select>
            </div>
            <div>
                <label>IMAGE PROOF</label>
                <input type="file" id="invImg" accept="image/*" onchange="previewImage(this)">
                <img id="photoPreview">
            </div>
        </div>
        <button id="btnAdd" onclick="addItem()" style="margin-top: 25px;">+ ADD TO INVENTORY</button>
    </div>

    <div class="card">
        <h2>CLOUD INVENTORY</h2>
        <div class="filter-bar">
            <input type="text" id="searchBox" class="filter-input" placeholder="Search..." onkeyup="runFilters()">
            <select id="filterLoc" class="filter-input" onchange="runFilters()">
                <option value="ALL">ALL LOCATIONS</option>
                <option value="OFFICE">OFFICE</option>
                <option value="MAIN STORE">MAIN STORE</option>
                <option value="ON VENUE">ON VENUE</option>
            </select>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="width:80px">IMAGE</th>
                        <th>ITEM DETAILS</th>
                        <th>LOCATION</th>
                        <th>STATUS</th>
                        <th style="width:100px">ACTION</th>
                    </tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
    <div id="printableArea" style="background:#fff; padding:30px; border-radius:15px; text-align:center; color: #000;">
        <canvas id="qrCanvas"></canvas>
        <h2 id="qrLabel" style="color:#000; margin-top:10px; border:none; font-size: 20px;"></h2>
        <p style="margin:0; font-size:10px; font-weight:bold; color:#000;">V.E.P ASSET MANAGEMENT</p>
    </div>
    <div style="margin-top:25px; display:flex; gap:15px;">
        <button onclick="printQR()" style="background:#4ade80; color:#000; width:auto; padding:12px 35px; border:none;">PRINT STICKER</button>
        <button onclick="document.getElementById('qrModal').style.display='none'" style="background:#333; color:#fff; width:auto; padding:12px 35px; border:none;">CLOSE</button>
    </div>
</div>

<div id="imageModal" onclick="this.style.display='none'">
    <img id="fullImage" src="">
</div>

<script>
// (Firebase Config)
const firebaseConfig = {
    apiKey: "AIzaSyBf_L5FuHaaERVG4N2qMl_4HIk-3-nw9Mk",
    authDomain: "vep-inventory.firebaseapp.com",
    databaseURL: "https://vep-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vep-inventory",
    storageBucket: "vep-inventory.firebasestorage.app",
    messagingSenderId: "858682132166",
    appId: "1:858682132166:web:fa05f064398fe418afb9c7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function zoomImg(src) {
    const modal = document.getElementById('imageModal');
    const fullImg = document.getElementById('fullImage');
    fullImg.src = src;
    modal.style.display = 'flex';
}

function previewImage(input) {
    const preview = document.getElementById('photoPreview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
        reader.readAsDataURL(input.files[0]);
    }
}

function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 600;
                let w = img.width, h = img.height;
                if (w > MAX) { h *= MAX / w; w = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                resolve(canvas.toDataURL("image/jpeg", 0.6));
            };
        };
    });
}

async function addItem() {
    const name = document.getElementById('invName').value.trim();
    const cat = document.getElementById('invCat').value.trim();
    const loc = document.getElementById('invLoc').value;
    const imgFile = document.getElementById('invImg').files[0];
    if(!name) return alert("Enter Item Name!");
    document.getElementById('btnAdd').disabled = true;
    let imgBase64 = imgFile ? await compressImage(imgFile) : "";
    const newRef = db.ref("items").push();
    await newRef.set({
        id: newRef.key, name, category: cat || "General",
        location: loc, image: imgBase64, status: "Available",
        lastUpdate: Date.now(), job: ""
    });
    alert("Success!"); location.reload();
}

db.ref("items").on("value", (snap) => {
    const table = document.getElementById("inventoryTable");
    const damageTable = document.getElementById("damageTable");
    const damageSection = document.getElementById("damageSection");
    table.innerHTML = ""; damageTable.innerHTML = "";
    let dCount = 0;

    snap.forEach((child) => {
        const item = child.val();
        const isStore = ["OFFICE", "MAIN STORE"].includes(item.location);
        const imgHTML = `<div class="img-box">${item.image ? `<img src="${item.image}" onclick="zoomImg(this.src)">` : `<small style="color:#333">NO IMG</small>`}</div>`;

        if(item.status === "DAMAGED") {
            dCount++;
            damageTable.innerHTML += `
                <tr>
                    <td><div style="display:flex; align-items:center; gap:15px;">${imgHTML} <div><b style="color:#ff4444">${item.name}</b><br><small>${item.lastReport || "Damaged"}</small></div></div></td>
                    <td style="text-align:right"><button class="btn-fixed" onclick="markAsFixed('${item.id}')">FIXED</button></td>
                </tr>`;
        }

        let sClass = isStore ? 'status-available' : 'status-inuse';
        let sText = isStore ? 'AVAILABLE' : 'IN USE';
        if(item.status === "DAMAGED") { sClass = 'status-damaged'; sText = 'DAMAGED'; }

        table.innerHTML += `
            <tr>
                <td>${imgHTML}</td>
                <td><b style="color:#fff; font-size:15px;">${item.name}</b><br><small style="color:#666">${item.category}</small></td>
                <td><span class="location-tag">${item.location}</span></td>
                <td><span class="${sClass}">● ${sText}</span><br><small style="color:#444">${item.job || ""}</small></td>
                <td>
                    <div class="action-cell">
                        <button class="btn-action btn-delete-new" onclick="if(confirm('Delete this item?')) db.ref('items/${child.key}').remove()">DELETE</button>
                        <button class="btn-action btn-qr-new" onclick="showQR('${child.key}', '${item.name}')">QR</button>
                    </div>
                </td>
            </tr>`;
    });
    damageSection.style.display = dCount > 0 ? "block" : "none";
});

function showQR(id, name) {
    const canvas = document.getElementById('qrCanvas');
    document.getElementById('qrLabel').innerText = name.toUpperCase();
    QRCode.toCanvas(canvas, id, { width: 200, margin: 1 }, (err) => {
        if(!err) document.getElementById('qrModal').style.display='flex';
    });
}
function printQR() { window.print(); }
async function markAsFixed(id) {
    if(confirm("Confirm item is repaired?")) {
        await db.ref("items/" + id).update({ status: "Available", location: "MAIN STORE", lastReport: null });
    }
}
function runFilters() {
    const s = document.getElementById('searchBox').value.toUpperCase();
    const rows = document.querySelectorAll("#inventoryTable tr");
    rows.forEach(r => {
        const txt = r.innerText.toUpperCase();
        r.style.display = txt.includes(s) ? "" : "none";
    });
}
</script>
</body>
</html>
